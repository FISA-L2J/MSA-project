name: Deploy to GKE

on:
  push:
    branches:
      - "main"
  workflow_dispatch:

env:
  PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  GKE_CLUSTER: msa-cluster
  GKE_ZONE: asia-northeast3-a
  GAR_LOCATION: asia-northeast3-docker.pkg.dev

jobs:
  setup-build-publish-deploy:
    name: Setup, Build, Publish, and Deploy
    runs-on: ubuntu-latest
    environment: production

    steps:
    - name: Checkout
      uses: actions/checkout@v3

    # 1. Authenticate to Google Cloud
    - id: 'auth'
      uses: 'google-github-actions/auth@v1'
      with:
        credentials_json: '${{ secrets.GCP_SA_KEY }}'

    # 2. Setup GCloud SDK
    - name: 'Set up Cloud SDK'
      uses: 'google-github-actions/setup-gcloud@v1'

    # 3. Configure Docker to use GCloud as credential helper
    - name: 'Docker auth'
      run: |-
        gcloud auth configure-docker ${{ env.GAR_LOCATION }}

    # 4. Build and Push Images (Multi-stage builds)
    - name: Build and Push Auth Service
      uses: docker/build-push-action@v4
      with:
        context: .
        file: ./auth-service/Dockerfile
        push: true
        tags: ${{ env.GAR_LOCATION }}/${{ env.PROJECT_ID }}/msa-repo/auth-service:latest

    - name: Build and Push Account Service
      uses: docker/build-push-action@v4
      with:
        context: .
        file: ./account-service/Dockerfile
        push: true
        tags: ${{ env.GAR_LOCATION }}/${{ env.PROJECT_ID }}/msa-repo/account-service:latest

    - name: Build and Push Transaction Service
      uses: docker/build-push-action@v4
      with:
        context: .
        file: ./transaction-service/Dockerfile
        push: true
        tags: ${{ env.GAR_LOCATION }}/${{ env.PROJECT_ID }}/msa-repo/transaction-service:latest

    # 5. Authenticate to GKE
    - name: Get GKE Credentials
      uses: google-github-actions/get-gke-credentials@v1
      with:
        cluster_name: ${{ env.GKE_CLUSTER }}
        location: ${{ env.GKE_ZONE }}

    # 6. Deploy Secrets (Dynamic Creation)
    - name: Create Secrets
      run: |
        # Create namespace first to put secret in it
        kubectl apply -f k8s/namespace.yaml
        
        # Create Secret idempotently
        kubectl create secret generic msa-secrets \
          --namespace=msa-project \
          --from-literal=postgres-user=user \
          --from-literal=postgres-password=${{ secrets.POSTGRES_PASSWORD }} \
          --from-literal=jwt-secret=${{ secrets.JWT_SECRET }} \
          --dry-run=client -o yaml | kubectl apply -f -

    # 7. Deploy Applications
    - name: Deploy to GKE
      run: |
        # Apply ConfigMaps (DB Init)
        kubectl apply -f k8s/postgres-init.yaml

        # Apply Infrastructure
        kubectl apply -f k8s/postgres.yaml
        kubectl apply -f k8s/redis.yaml
        kubectl apply -f k8s/zipkin.yaml
        kubectl apply -f k8s/nats.yaml
        kubectl apply -f k8s/istio-dashboard-json.yaml
        kubectl apply -f k8s/prometheus.yaml
        kubectl apply -f k8s/grafana.yaml
        kubectl apply -f k8s/kiali.yaml

        # Apply Services
        kubectl apply -f k8s/auth-service.yaml
        kubectl apply -f k8s/account-service.yaml
        kubectl apply -f k8s/transaction-service.yaml

        # Apply Istio Auth Policy
        kubectl apply -f k8s/istio-auth.yaml
        
        # Apply Istio Gateway & VirtualServices
        kubectl apply -f k8s/istio-gateway.yaml

        # Force Rolling Restart (to pick up new 'latest' images)
        kubectl rollout restart deployment/auth-service -n msa-project
        kubectl rollout restart deployment/account-service -n msa-project
        kubectl rollout restart deployment/transaction-service -n msa-project
